# Автоматический конвертер видео

Этот PowerShell скрипт автоматически отслеживает указанную исходную папку на наличие новых видеофайлов, конвертирует их с использованием FFmpeg с аппаратным ускорением NVIDIA CUDA и перемещает обработанные файлы в целевую папку. Он разработан для автоматической обработки видео, особенно полезен для конвертации загруженных видео в единый формат.

## Возможности

- **Автоматический мониторинг**: Отслеживает исходную директорию на наличие вновь созданных видеофайлов.
- **Интеграция с FFmpeg**: Использует FFmpeg для надежной конвертации видео.
- **Ускорение CUDA**: Использует графические процессоры NVIDIA для более быстрого кодирования (H.264 NVENC).
- **Стабилизация размера файла**: Ожидает полной записи файлов перед началом конвертации, предотвращая проблемы с неполными загрузками.
- **Настраиваемость**: Все пути, расширения и параметры конвертации настраиваются через файл `.env`.
- **Логирование**: Записывает все действия и ошибки в указанный файл журнала.
- **Уведомления в Telegram**: Отправляет обновления в реальном времени о загрузках видео и завершении конвертации в чат Telegram.
- **Обработка ошибок**: Включает проверки на отсутствие путей, FFmpeg и ошибки парсинга.

## Требования

- **PowerShell**: Версия 5.1 или выше (предустановлена в Windows).
- **FFmpeg**: Должен быть установлен, а путь к `ffmpeg.exe` указан в файле `.env`.
- **NVIDIA GPU (необязательно, но рекомендуется)**: Для ускорения CUDA требуется графический процессор NVIDIA с совместимыми драйверами.

## Установка

1. **Клонируйте репозиторий** (или загрузите скрипт):

    ```bash
    git clone https://github.com/neiromaster/auto-converter.git
    cd auto-converter
    ```

2. **Установите FFmpeg**: Загрузите последнюю сборку FFmpeg с [ffmpeg.org](https://ffmpeg.org/download.html) и распакуйте ее в любое место на вашей системе. Запомните путь к `ffmpeg.exe`.
3. **Создайте файл `.env`**: Создайте файл с именем `.env` в корневой директории проекта (там, где находится `auto-converter.ps1`). Подробности см. в разделе [Конфигурация](#конфигурация).

## Конфигурация

Создайте файл `.env` в корне проекта со следующими переменными:

```ini
# --- Пути к папкам ---
SOURCE_FOLDER="C:\Path\To\Your\SourceVideos"       # Папка для мониторинга новых видео
TARGET_FOLDER="C:\Path\To\Your\ConvertedVideos"    # Папка, куда будут сохраняться конвертированные видео
TEMP_FOLDER="C:\Path\To\Your\Temp"                 # Временная папка для промежуточных файлов

# --- Настройки FFmpeg ---
FFMPEG_PATH="C:\ffmpeg\bin\ffmpeg.exe"             # Абсолютный путь к ffmpeg.exe
VIDEO_EXTENSIONS=".mp4,.mkv,.avi,.mov"             # Список расширений видео через запятую для обработки
PREFIX="converted_"                                # Префикс для имен конвертированных файлов (например, converted_video.mkv)
IGNORE_PREFIX="temp_"                              # Файлы, начинающиеся с этого префикса, будут игнорироваться

# --- Стабилизация файла ---
USE_FILE_SIZE_STABILIZATION=true                   # Установите "true" для включения, "false" для отключения
MIN_FILE_SIZE_MB=10                                # Минимальный размер файла в МБ для начала обработки
STABILIZATION_CHECK_INTERVAL_SEC=5                 # Как часто проверять размер файла во время стабилизации
STABILIZATION_TIMEOUT_SEC=300                      # Максимальное время (секунды) ожидания стабилизации размера файла
STABILIZATION_TOLERANCE_BYTES=1024                 # Максимальная разница в байтах для определения стабильности размера файла

# --- Логирование ---
LOG_ENABLED=true                                   # Установите "true" для включения логирования, "false" для отключения
LOG_FILE="C:\Path\To\Your\auto-converter.log"      # Абсолютный путь к файлу журнала

# --- Уведомления Telegram (необязательно) ---
TELEGRAM_ENABLED=false                             # Установите "true" для включения уведомлений Telegram
TELEGRAM_BOT_TOKEN="YOUR_TELEGRAM_BOT_TOKEN"       # Токен вашего бота Telegram API
TELEGRAM_CHANNEL_ID=-1234567890                    # ID вашего канала Telegram (например, -1001234567890 для канала)
```

**Важные примечания для Telegram:**

- Чтобы получить `TELEGRAM_BOT_TOKEN`, поговорите с BotFather в Telegram и создайте нового бота.
- Чтобы получить `TELEGRAM_CHANNEL_ID`, добавьте своего бота в канал в качестве администратора. Затем отправьте сообщение в канал и используйте `https://api.telegram.org/bot<YOUR_BOT_TOKEN>/getUpdates` в браузере. Ищите объект `chat` и его поле `id` (для каналов это будет отрицательное число).

## Использование

Чтобы запустить скрипт, откройте PowerShell, перейдите в директорию проекта, затем выполните:

```powershell
.\auto-converter.ps1
```

Скрипт начнет мониторинг `SOURCE_FOLDER`. Чтобы остановить скрипт, нажмите `Ctrl+C`.

## Как это работает

1. **Загружает конфигурацию**: Считывает настройки из файла `.env`.
2. **Мониторит исходную папку**: Использует `FileSystemWatcher` для обнаружения новых файлов.
3. **Стабилизация файла**: Если включено, постоянно проверяет размер файла, пока он не стабилизируется, гарантируя полную загрузку/копирование файла.
4. **Конвертация FFmpeg**: После обнаружения и стабилизации видеофайла, использует FFmpeg для его конвертации. Пытается использовать `cuvid` для декодирования и `h264_nvenc` для кодирования, если присутствует графический процессор NVIDIA.
5. **Перемещение в целевую папку**: После успешной конвертации новый файл перемещается в `TARGET_FOLDER`.
6. **Логирование и уведомления**: Записывает все значимые события и отправляет уведомления в Telegram, если настроено.

## Устранение неполадок

- **`FFmpeg не найден`**: Убедитесь, что `FFMPEG_PATH` в вашем файле `.env` указывает на правильное расположение `ffmpeg.exe`.
- **`Путь не существует`**: Убедитесь, что пути `SOURCE_FOLDER`, `TARGET_FOLDER`, `TEMP_FOLDER` и `LOG_FILE` в вашем `.env` верны и доступны.
- **`Ошибка парсинга настроек`**: Проверьте файл `.env` на правильность типов переменных (например, `true`/`false` для булевых, числа для целых).
- **Проблемы с конвертацией**: Проверьте файл журнала на наличие ошибок FFmpeg. Убедитесь, что ваши драйверы NVIDIA обновлены, если используется ускорение CUDA.
- **Сообщения Telegram не отправляются**: Дважды проверьте `TELEGRAM_BOT_TOKEN` и `TELEGRAM_CHANNEL_ID` в файле `.env`. Убедитесь, что ваш бот имеет права администратора в канале.

Для получения дополнительной помощи, пожалуйста, обратитесь к исходному коду скрипта (`auto-converter.ps1`) для получения подробной логики и сообщений об ошибках.
