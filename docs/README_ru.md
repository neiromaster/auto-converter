# Автоматический конвертер видео

Этот PowerShell скрипт автоматически отслеживает указанную исходную папку на наличие новых видеофайлов, конвертирует их с использованием FFmpeg с аппаратным ускорением NVIDIA CUDA, извлекает субтитры и перемещает обработанные файлы в целевую папку. Он разработан для автоматической обработки видео, особенно полезен для конвертации загруженных видео в единый формат.

## Возможности

- **Автоматический мониторинг**: Отслеживает исходную директорию на наличие вновь созданных видеофайлов.
- **Интеграция с FFmpeg**: Использует FFmpeg для надежной конвертации видео.
- **Ускорение CUDA**: Использует графические процессоры NVIDIA для более быстрого кодирования (H.264 NVENC).
- **Управление субтитрами**: Автоматически извлекает дорожки субтитров из видеофайлов для указанных языков, а также конвертирует отдельно скачанные файлы субтитров (например, `.ass`, `.vtt`) в стандартный формат `.srt`.
- **Стабилизация размера файла**: Ожидает полной записи файлов перед началом конвертации, предотвращая проблемы с неполными загрузками.
- **Умное копирование файлов**: Копирует исходные и сконвертированные файлы в папку назначения, интеллектуально сопоставляя имена файлов с именами подпапок.
- **Настраиваемость**: Все пути, расширения и параметры конвертации настраиваются через файл `config.yaml`.
- **Логирование**: Записывает все действия и ошибки в указанный файл журнала.
- **Уведомления в Telegram**: Отправляет обновления в реальном времени о загрузках и завершении конвертации в канал Telegram, а также может уведомлять конкретного пользователя об операциях копирования.
- **Автоматические обновления**: Может автоматически проверять наличие новых версий на GitHub и обновляться.
- **Обработка ошибок**: Включает проверки на отсутствие путей, FFmpeg и ошибки парсинга.

## Требования

- **PowerShell**: Версия 5.1 или выше (предустановлена в Windows).
- **FFmpeg**: Должен быть установлен, а путь к `ffmpeg.exe` указан в файле `config.yaml`.
- **NVIDIA GPU (необязательно, но рекомендуется)**: Для ускорения CUDA требуется графический процессор NVIDIA с совместимыми драйверами.
- **powershell-yaml**: Скрипт попытается установить этот модуль автоматически.

## Установка

1. **Клонируйте репозиторий** (или загрузите скрипт):

    ```bash
    git clone https://github.com/neiromaster/auto-converter.git
    cd auto-converter
    ```

2. **Установите FFmpeg**: Загрузите последнюю сборку FFmpeg с [ffmpeg.org](https://ffmpeg.org/download.html) и распакуйте ее в любое место на вашей системе. Запомните путь к `ffmpeg.exe`.
3. **Создайте файл `config.yaml`**: Создайте файл с именем `config.yaml` в корневой директории проекта (там, где находится `auto-converter.ps1`). Подробности см. в разделе [Конфигурация](#конфигурация).
4. **Создайте файл `.env`**: Создайте файл с именем `.env` в корне проекта для хранения секретов Telegram.

## Конфигурация

Создайте файл `config.yaml` в корне проекта со следующей структурой:

```yaml
paths:
  source_folder: D:\disc\YandexDisk\sync
  target_folder: D:\disc\YandexDisk\sync
  temp_folder: '%TEMP%'
  destination_folder: D:\disc2\Yandex.Disk\Равки 2 # Необязательно: для умного копирования

settings:
  min_file_size_mb: 800
  prefix: жат-
  ignore_prefix: жат-
  telegram_enabled: true
  auto_update_enabled: true # Установите false, чтобы отключить авто-обновление

ffmpeg:
  ffmpeg_path: D:/scoop/shims/ffmpeg.exe

video_extensions:
  - .mp4
  - .avi
  - .mov
  - .wmv
  - .flv
  - .webm
  - .mkv
  - .m4v

subtitle_extension:
  - .vtt
  - .srt
  - .ass

subtitles:
  extract_languages:
    - rus
    - eng

stabilization_strategy:
  use_file_size_stabilization: true
  stabilization_check_interval_sec: 5
  stabilization_timeout_sec: 600

logging:
  log_file: auto-converter.log
```

Создайте файл `.env` в корне проекта для токена вашего бота Telegram и ID чатов:

```ini
TELEGRAM_BOT_TOKEN="YOUR_TELEGRAM_BOT_TOKEN"
TELEGRAM_CHANNEL_ID=-1001234567890 # ID канала для общих уведомлений
TELEGRAM_CHAT_ID=123456789 # Ваш личный ID чата для уведомлений об операциях копирования
```

**Важные примечания для Telegram:**

- Чтобы получить `TELEGRAM_BOT_TOKEN`, поговорите с BotFather в Telegram и создайте нового бота.
- Чтобы получить `TELEGRAM_CHANNEL_ID`, добавьте своего бота в канал в качестве администратора. Затем отправьте сообщение в канал и используйте `https://api.telegram.org/bot<YOUR_BOT_TOKEN>/getUpdates` в браузере. Ищите объект `chat` и его поле `id`.
- Чтобы получить личный `TELEGRAM_CHAT_ID`, отправьте сообщение своему боту и используйте ту же ссылку `getUpdates`. Найдите объект `chat` и его `id` из вашего личного сообщения.

## Использование

Чтобы запустить скрипт, откройте PowerShell, перейдите в директорию проекта, затем выполните:

```powershell
.\auto-converter.ps1
```

Скрипт начнет мониторинг `SOURCE_FOLDER`. Чтобы остановить скрипт, нажмите `Ctrl+C`.

## Как это работает

1. **Загрузка конфигурации**: Считывает настройки из файлов `config.yaml` и `.env`.
2. **Проверка обновлений**: Если `auto_update_enabled` равно `true`, скрипт проверяет наличие новой версии на GitHub. Если она найдена, он загружает и применяет обновление, после чего перезапускается.
3. **Мониторинг исходной папки**: Использует `FileSystemWatcher` для обнаружения новых файлов.
4. **Обработка субтитров**: Если новый файл — это отдельный файл субтитров (например, `.ass`), он автоматически конвертируется в `.srt`.
5. **Стабилизация файла**: Для видеофайлов скрипт постоянно проверяет размер файла, пока он не стабилизируется, гарантируя полную загрузку/копирование.
6. **Умное копирование (до конвертации)**: Если указана `destination_folder`, скрипт ищет в ней подпапку, имя которой частично совпадает с именем нового видеофайла. Затем он копирует исходный видеофайл в эту папку.
7. **Извлечение субтитров**: Если в видео есть дорожки субтитров с языками, указанными в `subtitles.extract_languages`, они будут извлечены в файлы `.srt`.
8. **Конвертация FFmpeg**: После обнаружения и стабилизации видеофайла, используется FFmpeg для его конвертации. Скрипт пытается использовать `cuvid` для декодирования и `h264_nvenc` для кодирования при наличии GPU от NVIDIA.
9. **Перемещение в целевую папку**: После успешной конвертации новый файл перемещается в `TARGET_FOLDER`.
10. **Умное копирование (после конвертации)**: Новый сконвертированный файл также копируется в ту же найденную подпапку внутри `destination_folder`.
11. **Логирование и уведомления**: Записывает все значимые события. Отправляет уведомления в `TELEGRAM_CHANNEL_ID` о загрузках и конвертациях, и в `TELEGRAM_CHAT_ID` о результатах операций копирования.

## Структура проекта

Проект включает скрипт `builder.ps1`. Этот скрипт используется для разработки, чтобы объединить основной скрипт `auto-converter.ps1` и все его модули из папки `includes` в единый, готовый к распространению файл `dist/auto-converter.ps1`. Для обычного использования запускать его не нужно.

## Устранение неполадок

- **`FFmpeg не найден`**: Убедитесь, что `ffmpeg_path` в вашем файле `config.yaml` указывает на правильное расположение `ffmpeg.exe`.
- **`Путь не существует`**: Убедитесь, что пути `source_folder`, `target_folder` и `temp_folder` в вашем `config.yaml` верны и доступны.
- **`Ошибка парсинга настроек`**: Проверьте файл `config.yaml` на правильность структуры и типов данных.
- **Проблемы с конвертацией**: Проверьте файл журнала на наличие ошибок FFmpeg. Убедитесь, что ваши драйверы NVIDIA обновлены, если используется ускорение CUDA.
- **Сообщения Telegram не отправляются**: Дважды проверьте `TELEGRAM_BOT_TOKEN`, `TELEGRAM_CHANNEL_ID` и `TELEGRAM_CHAT_ID` в файле `.env`. Убедитесь, что у вашего бота есть необходимые разрешения.
